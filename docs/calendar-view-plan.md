# カレンダービュー 実装計画

## 1. 概要

要件定義 §2.3「可視化」に基づき、`/app/history` ルートに**カレンダービュー**と**サマリー**を実装する。

現状:
- ボトムナビの「履歴」タブは `disabled: true` / "Coming soon" で無効化済み
- `/app/history` ルート・ファイルは未作成

---

## 2. 実装スコープ

### 今回実装する

| 機能 | 詳細 |
|------|------|
| サマリーカード | 今週 / 前週の合計確認回数と増減比較 |
| カレンダービュー | 日ごとの確認合計をヒートマップ的に表示（月単位・月ナビ付き） |
| 日付タップ → ログ一覧 | 選択日のアイテム別回数をモーダルで表示 |
| 履歴タブの有効化 | ボトムナビ「📊 履歴」を有効化してリンクを通す |

### スコープ外（将来対応）

- グラフビュー（折れ線グラフ、Recharts）
- 確認ログの編集・削除
- データエクスポート（別途 §2.4）

---

## 3. ファイル構成

### 新規作成

```
app/routes/
  app-history.tsx     # /app/history ページ本体
```

### 変更

| ファイル | 変更内容 |
|----------|----------|
| `app/routes.ts` | `route("history", "routes/app-history.tsx")` を追加 |
| `app/routes/app.tsx` | `navItems` の履歴タブを `disabled: false` に変更 |

---

## 4. ライブラリ選定

| 用途 | 採用 | 理由 |
|------|------|------|
| カレンダーグリッド | **自作**（依存なし） | 7列グリッドは単純な JSX で十分。react-day-picker はヒートマップ用セルのカスタマイズが複雑で、今回の用途に対してオーバースペック |

---

## 5. ルーティング・URL 設計

```
/app/history              # デフォルト: 当月のカレンダービュー
/app/history?month=2026-01  # 月ナビ（YYYY-MM 形式）
```

URL サーチパラメータで月を保持し、ブラウザバックでも表示月が維持されるようにする。

---

## 6. データ設計

### 6.1 Loader で取得するデータ

```typescript
type LoaderData = {
  // サマリー
  summary: {
    thisWeek: number;   // 今週（月曜起点）の合計確認回数
    lastWeek: number;   // 前週の合計確認回数
  };
  // カレンダー用: 選択月の日別合計
  calendarData: {
    date: string;    // "2026-02-14"
    count: number;
  }[];
  // 選択月
  currentMonth: string; // "2026-02"
};
```

### 6.2 Supabase クエリ方針（アプリ集計）

選択月の全ログを取得し、TypeScript 側で日付ごとに集計する。

```typescript
// 選択月の check_logs を全件取得（check_item_id 付き）
const { data: monthLogs } = await supabase
  .from("check_logs")
  .select("check_item_id, checked_at")
  .gte("checked_at", monthStart.toISOString())
  .lt("checked_at", nextMonthStart.toISOString());

// TS 側で { "2026-02-14": 5, ... } に集計
```

サマリー用（今週 + 前週）も同様に2クエリで取得しアプリ側集計。

---

## 7. タイムゾーン対応方針

**課題**: Vercel のサーバー環境は UTC。`new Date().setHours(0, 0, 0, 0)` は UTC 基準になり、JST（UTC+9）とズレる。

**対応方針（本実装で採用）**:

```typescript
// JST の月境界を UTC として計算するユーティリティ
// JST 00:00 = UTC 前日 15:00（-9h）
function jstMonthBounds(year: number, month: number) {
  // month は 1-based
  const start = new Date(Date.UTC(year, month - 1, 1, -9, 0, 0));   // JST 月初 00:00
  const end   = new Date(Date.UTC(year, month, 1, -9, 0, 0));       // JST 翌月初 00:00
  return { start, end };
}

// ログの checked_at (UTC) を JST の "YYYY-MM-DD" に変換
function toJSTDateString(utcISOString: string): string {
  const d = new Date(new Date(utcISOString).getTime() + 9 * 60 * 60 * 1000);
  return d.toISOString().slice(0, 10);
}
```

**週の起点**: 月曜日（ISO週）を使用。

> **既存コード（app-home.tsx）の影響**: 既存の `todayStart.setHours(0,0,0,0)` もタイムゾーン問題を抱えているが、スコープ外のため今回は触れない。

---

## 8. UI 設計

### 8.1 ページ全体レイアウト

```
┌─────────────────────┐
│  ヘッダー（日付・⚙️） │  ← 既存 app.tsx が提供
├─────────────────────┤
│  ┌───────────────┐  │
│  │ 今週  12回    │  │  ← サマリーカード
│  │ 前週   8回 ↑+4│  │
│  └───────────────┘  │
├─────────────────────┤
│  < 2026年2月 >       │  ← 月ナビ
│                     │
│  日 月 火 水 木 金 土 │
│   1  2  3  4  5  6  7│  ← 各セルに回数 & 色濃度
│   8  9 10 11 12 13 14│
│  15 16 17 18 19 20 21│
│  22 23 24 25 26 27 28│
│                     │
├─────────────────────┤
│ 🏠     📊     ⚙️    │
└─────────────────────┘
```

### 8.2 カレンダーセル

```
┌─────┐
│  14 │  ← 日付
│  5  │  ← 件数（0件は表示しない）
└─────┘
```

**カラーパレット（警告的表現を避けるため sky 系）**:

| 件数 | Tailwind クラス |
|------|----------------|
| 0    | `bg-slate-100 text-slate-300` |
| 1-2  | `bg-sky-100 text-sky-700` |
| 3-5  | `bg-sky-200 text-sky-800` |
| 6+   | `bg-sky-300 text-sky-900` |

### 8.3 選択日モーダル（カレンダーセルタップ時）

```
┌─────────────────────────────┐
│                             │  ← 背景オーバーレイ（タップで閉じる）
│  ┌───────────────────────┐  │
│  │ 2月14日の記録      ×  │  │
│  │───────────────────────│  │
│  │ 🔑 玄関の鍵       3回 │  │
│  │ 🔥 ガスの元栓     1回 │  │
│  │ 🪟 窓の施錠       1回 │  │
│  │                       │  │
│  │  合計  5回            │  │
│  └───────────────────────┘  │
│                             │
└─────────────────────────────┘
```

- 0件の日はタップしても何も起きない（またはモーダルを表示しない）
- 各アイテム行へのアクションは提供しない（表示のみ）

---

## 9. 実装ステップ

| ステップ | 内容 |
|----------|------|
| 1 | `routes.ts` に history ルートを追加 |
| 2 | `app.tsx` の履歴タブを有効化（`disabled: false`） |
| 3 | `app-history.tsx` の loader を実装（サマリー + カレンダーデータ取得、タイムゾーンユーティリティ含む） |
| 4 | サマリーカードコンポーネント実装 |
| 5 | カレンダーグリッドコンポーネント実装（月ナビ + ヒートマップセル） |
| 6 | 選択日モーダルコンポーネント実装 |
| 7 | 動作確認・モバイル調整 |

---

## 10. 決定事項まとめ

| 事項 | 決定内容 |
|------|---------|
| グラフビュー | 今回は実装しない（将来フェーズで追加） |
| 選択日の詳細 | モーダル表示（アイテム別回数の一覧のみ。詳細画面への遷移なし） |
| サマリー表示 | 今週 / 前週の合計回数と増減 |
| 日付集計 | アプリ側（TypeScript）で集計 |
| 週の起点 | 月曜日（ISO週） |
